<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Blitz - A Fun Quiz Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <!-- Tone.js for simple audio feedback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Apply 'Inter' font to the body */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom animation for card shake on wrong answer */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }

        /* Custom animation for score counting up */
        @keyframes count-up {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        .count-up {
            animation: count-up 0.2s ease-out;
        }

        /* Custom styles for the timer bar, ensuring smooth width transition */
        #timer-bar {
            transition: width 0.1s linear; /* Default transition, overridden for full duration in JS */
        }
        
        /* Custom styles for confetti particles */
        .confetti {
            width: 10px;
            height: 10px;
            position: absolute;
            top: -20px; /* Start above the container */
            animation: fall 3s linear infinite; /* Animation for falling effect */
            border-radius: 50%; /* Make confetti round */
        }
        /* Keyframe animation for confetti falling */
        @keyframes fall {
            to {
                transform: translateY(100vh); /* Fall to the bottom of the viewport */
                opacity: 0; /* Fade out as it falls */
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-white flex items-center justify-center min-h-screen p-4 transition-all duration-500">

    <div id="game-container" class="w-full max-w-2xl mx-auto">

        <!-- 1. Home Screen -->
        <div id="home-screen" class="text-center">
            <h1 class="text-6xl font-black text-yellow-400 mb-2">Brain Blitz</h1>
            <p class="text-slate-300 mb-8">Test your knowledge and beat the clock!</p>
            
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Choose a Category</h2>
                <div id="category-selector" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Categories will be dynamically injected here by JavaScript -->
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Choose Difficulty</h2>
                <div id="difficulty-selector" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Difficulties will be dynamically injected here by JavaScript -->
                </div>
            </div>

            <button id="start-quiz-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-8 rounded-full text-2xl w-full md:w-auto transition-transform transform hover:scale-105 shadow-lg disabled:bg-slate-500 disabled:cursor-not-allowed" disabled>Select Category & Difficulty to Start</button>
            
            <div class="mt-8 text-slate-400">
                <h3 class="text-xl font-semibold mb-2">How to Play</h3>
                <p>Select a category and difficulty, answer 5 questions per round, and score points for speed and accuracy!</p>
                <p class="mt-2 text-sm">Use keys 1, 2, 3, 4 for quick answers on desktop.</p>
            </div>
        </div>

        <!-- 2. Gameplay Screen -->
        <div id="game-screen" class="hidden">
            <!-- Top Bar: Progress & Score -->
            <div class="flex justify-between items-center mb-4">
                <div class="w-1/4">
                    <p class="text-sm text-slate-300">Question</p>
                    <p id="question-counter" class="text-xl font-bold">1 / 5</p>
                </div>
                <div class="w-1/2 text-center">
                    <div class="w-full bg-slate-700 rounded-full h-2.5">
                        <div id="timer-bar" class="bg-yellow-400 h-2.5 rounded-full" style="width: 100%"></div>
                    </div>
                </div>
                <div class="w-1/4 text-right">
                    <p class="text-sm text-slate-300">Score</p>
                    <p id="score-display" class="text-xl font-bold">0</p>
                </div>
            </div>

            <!-- Question Card -->
            <div id="question-card" class="bg-slate-800 p-8 rounded-2xl shadow-2xl transition-all duration-300">
                <p id="question-text" class="text-2xl md:text-3xl font-semibold mb-8 min-h-[100px]">Loading question...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Options will be dynamically injected here -->
                </div>
            </div>
        </div>

        <!-- 3. Result Screen -->
        <div id="result-screen" class="hidden text-center relative overflow-hidden">
            <div id="confetti-container" class="absolute inset-0 pointer-events-none z-0"></div> <!-- Confetti container -->
            <h2 class="text-3xl font-bold text-yellow-400 mb-2">Quiz Complete!</h2>
            <p class="text-slate-300 text-xl mb-6">Here's how you did:</p>
            
            <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl mb-8 max-w-md mx-auto z-10 relative"> <!-- Ensure content is above confetti -->
                <p class="text-slate-400 text-lg">Your Final Score</p>
                <p id="final-score" class="text-7xl font-black my-4">0</p>
                
                <div class="flex justify-around text-lg">
                    <div>
                        <p class="text-slate-400">Correct</p>
                        <p id="correct-answers" class="font-bold text-green-400 text-2xl">0</p>
                    </div>
                    <div>
                        <p class="text-slate-400">Incorrect</p>
                        <p id="incorrect-answers" class="font-bold text-red-400 text-2xl">0</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-center gap-4 z-10 relative"> <!-- Ensure buttons are above confetti -->
                <button id="play-again-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full text-lg transition-transform transform hover:scale-105">Play Again</button>
                <button id="home-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-6 rounded-full text-lg transition-transform transform hover:scale-105">Back to Home</button>
            </div>
        </div>

    </div>

    <script>
        // --- DOM ELEMENTS ---
        const homeScreen = document.getElementById('home-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultScreen = document.getElementById('result-screen');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const categorySelector = document.getElementById('category-selector');
        const difficultySelector = document.getElementById('difficulty-selector'); // New difficulty selector

        const questionCounter = document.getElementById('question-counter');
        const scoreDisplay = document.getElementById('score-display');
        const timerBar = document.getElementById('timer-bar');
        const questionCard = document.getElementById('question-card');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');

        const finalScore = document.getElementById('final-score');
        const correctAnswers = document.getElementById('correct-answers');
        const incorrectAnswers = document.getElementById('incorrect-answers');
        const playAgainBtn = document.getElementById('play-again-btn');
        const homeBtn = document.getElementById('home-btn');
        const confettiContainer = document.getElementById('confetti-container');

        // --- GAME CONFIG ---
        const QUESTIONS_PER_ROUND = 5;
        const TIME_PER_QUESTION_CONFIG = {
            'easy': 20, // 20 seconds for easy
            'medium': 15, // 15 seconds for medium
            'hard': 10   // 10 seconds for hard
        };

        // --- GAME DATA ---
        // Quiz questions categorized by topic and difficulty
        const quizData = {
            "General Knowledge": {
                'easy': [
                    { question: "What is the capital of France?", options: ["Berlin", "Madrid", "Paris", "Rome"], answer: "Paris" },
                    { question: "What is the largest planet in our solar system?", options: ["Earth", "Jupiter", "Mars", "Saturn"], answer: "Jupiter" },
                    { question: "Who wrote 'To Kill a Mockingbird'?", options: ["Harper Lee", "J.K. Rowling", "Ernest Hemingway", "Mark Twain"], answer: "Harper Lee" },
                    { question: "What is the chemical symbol for water?", options: ["O2", "CO2", "H2O", "NaCl"], answer: "H2O" },
                    { question: "Which ocean is the largest?", options: ["Atlantic", "Indian", "Arctic", "Pacific"], answer: "Pacific" },
                    { question: "How many continents are there?", options: ["5", "6", "7", "8"], answer: "7" },
                ],
                'medium': [
                    { question: "Which mountain is the highest in the world?", options: ["K2", "Mount Everest", "Kangchenjunga", "Lhotse"], answer: "Mount Everest" },
                    { question: "What is the longest river in the world?", options: ["Amazon", "Nile", "Yangtze", "Mississippi"], answer: "Nile" },
                    { question: "Who painted the Mona Lisa?", options: ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Claude Monet"], answer: "Leonardo da Vinci" },
                    { question: "Which country is famous for the Great Wall?", options: ["Japan", "India", "China", "Egypt"], answer: "China" },
                    { question: "What is the primary gas in Earth's atmosphere?", options: ["Oxygen", "Carbon Dioxide", "Nitrogen", "Argon"], answer: "Nitrogen" },
                    { question: "What is the capital of Japan?", options: ["Seoul", "Beijing", "Tokyo", "Bangkok"], answer: "Tokyo" },
                ],
                'hard': [
                    { question: "Which element has the atomic number 79?", options: ["Silver", "Gold", "Mercury", "Lead"], answer: "Gold" },
                    { question: "What is the smallest country in the world?", options: ["Monaco", "Nauru", "Vatican City", "San Marino"], answer: "Vatican City" },
                    { question: "Who developed the theory of relativity?", options: ["Isaac Newton", "Niels Bohr", "Albert Einstein", "Marie Curie"], answer: "Albert Einstein" },
                    { question: "Which planet is known as the 'Red Planet'?", options: ["Jupiter", "Venus", "Mars", "Saturn"], answer: "Mars" },
                    { question: "What is the deepest point in the Earth's oceans?", options: ["Puerto Rico Trench", "Java Trench", "Mariana Trench", "Kermadec Trench"], answer: "Mariana Trench" },
                    { question: "Which of these is not a primary color of light?", options: ["Red", "Green", "Blue", "Yellow"], answer: "Yellow" },
                ]
            },
            "Technology": {
                'easy': [
                    { question: "What does CPU stand for?", options: ["Central Process Unit", "Central Processing Unit", "Computer Personal Unit", "Central Processor Unit"], answer: "Central Processing Unit" },
                    { question: "What does 'WWW' stand for?", options: ["World Wide Web", "World Wide Widget", "Web World Wide", "Wide Web World"], answer: "World Wide Web" },
                    { question: "Which one is an input device?", options: ["Monitor", "Printer", "Keyboard", "Speaker"], answer: "Keyboard" },
                    { question: "What company makes the iPhone?", options: ["Samsung", "Google", "Microsoft", "Apple"], answer: "Apple" },
                    { question: "Which symbol is used for email addresses?", options: ["#", "@", "$", "%"], answer: "@" },
                ],
                'medium': [
                    { question: "Which company developed the Python programming language?", options: ["Google", "Microsoft", "Python Software Foundation", "Facebook"], answer: "Python Software Foundation" },
                    { question: "What does 'HTTP' stand for?", options: ["HyperText Transfer Protocol", "HyperText Transmission Protocol", "Hyperlink Transfer Protocol", "Hyperlink Transmission Protocol"], answer: "HyperText Transfer Protocol" },
                    { question: "In what year was the first iPhone released?", options: ["2005", "2007", "2008", "2010"], answer: "2007" },
                    { question: "What is the main function of a router?", options: ["Store data", "Connect to the internet", "Display graphics", "Forward data packets"], answer: "Forward data packets" },
                    { question: "What is the smallest unit of data in a computer?", options: ["Byte", "Kilobyte", "Bit", "Gigabyte"], answer: "Bit" },
                    { question: "Which is a popular version control system?", options: ["Jira", "Slack", "Git", "Trello"], answer: "Git" },
                ],
                'hard': [
                    { question: "What is the name of the first computer programmer?", options: ["Bill Gates", "Ada Lovelace", "Charles Babbage", "Alan Turing"], answer: "Ada Lovelace" },
                    { question: "Which encryption method is often used for securing web traffic?", options: ["MD5", "SHA-256", "AES", "RSA"], answer: "RSA" },
                    { question: "What is the purpose of an API?", options: ["To store data", "To manage hardware", "To allow software components to communicate", "To display graphics"], answer: "To allow software components to communicate" },
                    { question: "What does SQL stand for?", options: ["Structured Question Language", "Standard Query Language", "Structured Query Logic", "Sequential Query Language"], answer: "Structured Query Language" },
                    { question: "Which company developed the JavaScript programming language?", options: ["Microsoft", "Google", "Netscape", "Sun Microsystems"], answer: "Netscape" },
                    { question: "What is a 'fork' in blockchain terminology?", options: ["A type of cryptocurrency", "A split in the blockchain's history", "A mining tool", "A new transaction"], answer: "A split in the blockchain's history" },
                ]
            },
            "History": {
                'easy': [
                    { question: "Who was the first President of the United States?", options: ["Abraham Lincoln", "Thomas Jefferson", "George Washington", "John Adams"], answer: "George Washington" },
                    { question: "In which year did World War II end?", options: ["1942", "1945", "1950", "1939"], answer: "1945" },
                    { question: "The ancient city of Rome was built on how many hills?", options: ["Five", "Seven", "Nine", "Three"], answer: "Seven" },
                    { question: "Who discovered penicillin?", options: ["Marie Curie", "Albert Einstein", "Alexander Fleming", "Isaac Newton"], answer: "Alexander Fleming" },
                    { question: "The Renaissance began in which country?", options: ["France", "England", "Spain", "Italy"], answer: "Italy" },
                ],
                'medium': [
                    { question: "When did the French Revolution begin?", options: ["1776", "1789", "1804", "1815"], answer: "1789" },
                    { question: "Who was the queen of ancient Egypt?", options: ["Nefertiti", "Hatshepsut", "Cleopatra", "Sobekneferu"], answer: "Cleopatra" },
                    { question: "Which empire was ruled by Genghis Khan?", options: ["Roman Empire", "Ottoman Empire", "Mongol Empire", "Persian Empire"], answer: "Mongol Empire" },
                    { question: "The American Civil War was fought between which years?", options: ["1850-1855", "1861-1865", "1870-1875", "1845-1850"], answer: "1861-1865" },
                    { question: "What was the primary purpose of the ancient Roman aqueducts?", options: ["Transportation", "Irrigation", "Water supply", "Defense"], answer: "Water supply" },
                ],
                'hard': [
                    { question: "Which ancient civilization developed the concept of zero?", options: ["Greeks", "Romans", "Mayans", "Egyptians"], answer: "Mayans" },
                    { question: "Who was the last pharaoh of Egypt?", options: ["Tutankhamun", "Ramses II", "Cleopatra VII", "Akhenaten"], answer: "Cleopatra VII" },
                    { question: "The Battle of Waterloo took place in which year?", options: ["1805", "1812", "1815", "1821"], answer: "1815" },
                    { question: "Which document was signed in 1215 in England, limiting the power of the king?", options: ["Bill of Rights", "Magna Carta", "Act of Supremacy", "Petition of Right"], answer: "Magna Carta" },
                    { question: "Who led the Soviet Union during the Cuban Missile Crisis?", options: ["Joseph Stalin", "Mikhail Gorbachev", "Nikita Khrushchev", "Leon Trotsky"], answer: "Nikita Khrushchev" },
                ]
            },
            "Anime": {
                'easy': [
                    { question: "Who is the main protagonist of 'Dragon Ball Z'?", options: ["Vegeta", "Gohan", "Goku", "Piccolo"], answer: "Goku" },
                    { question: "In 'Naruto', what is the name of the nine-tailed fox sealed inside the main character?", options: ["Shukaku", "Kurama", "Matatabi", "Gyuki"], answer: "Kurama" },
                    { question: "What is the name of the pirate crew led by Monkey D. Luffy in 'One Piece'?", options: ["Straw Hat Pirates", "Heart Pirates", "Kid Pirates", "Blackbeard Pirates"], answer: "Straw Hat Pirates" },
                    { question: "Which anime features characters named Eren, Mikasa, and Armin?", options: ["Demon Slayer", "Jujutsu Kaisen", "My Hero Academia", "Attack on Titan"], answer: "Attack on Titan" },
                    { question: "In 'Death Note', what must be written in the notebook to kill someone?", options: ["Their full name", "Their birth date", "A cause of death", "Their address"], answer: "Their full name" },
                ],
                'medium': [
                    { question: "What is the ultimate goal of Gon Freecss in 'Hunter x Hunter'?", options: ["Become a Hokage", "Find his father", "Become the Pirate King", "Win the Holy Grail War"], answer: "Find his father" },
                    { question: "In 'Fullmetal Alchemist', what is the law of Equivalent Exchange?", options: ["You must give up something of equal value to gain something.", "Everything has a price.", "Alchemy is magic.", "Truth is subjective."], answer: "You must give up something of equal value to gain something." },
                    { question: "What is the name of the organization that investigates demons in 'Demon Slayer'?", options: ["Demon Slayer Corps", "Soul Reapers", "Jujutsu Sorcerers", "Survey Corps"], answer: "Demon Slayer Corps" },
                    { question: "What is the name of the main city in 'Attack on Titan' where humanity resides?", options: ["Shiganshina", "Stohess", "Trost", "All of the above"], answer: "All of the above" },
                    { question: "Which anime features a character who can erase anyone from existence with a single touch?", options: ["One-Punch Man", "Mob Psycho 100", "Erased", "Kira Yoshikage (Jojo's Bizarre Adventure)"], answer: "Kira Yoshikage (Jojo's Bizarre Adventure)" },
                ],
                'hard': [
                    { question: "What is the name of the sentient book in 'Re:Zero - Starting Life in Another World'?", options: ["Beatrice", "Rem", "Ram", "Emilia"], answer: "Beatrice" },
                    { question: "In 'Psycho-Pass', what is the system that assesses a person's mental state and crime potential?", options: ["Sibyl System", "Akashic Records", "Dominator", "Crime Coefficient"], answer: "Sibyl System" },
                    { question: "Which character in 'Code Geass' possesses the Geass power to command absolute obedience?", options: ["Suzaku Kururugi", "C.C.", "Lelouch Lamperouge", "Kallen Stadtfeld"], answer: "Lelouch Lamperouge" },
                    { question: "What is the name of the cursed technique that Gojo Satoru uses in 'Jujutsu Kaisen' to manipulate space?", options: ["Limitless", "Red", "Blue", "Hollow Purple"], answer: "Limitless" },
                    { question: "In 'Steins;Gate', what device allows messages to be sent to the past?", options: ["D-Mail", "Time Machine", "Phonewave", "Future Gadget"], answer: "Phonewave" },
                ]
            }
        };

        // --- GAME STATE ---
        let currentQuestions = []; // Array to hold questions for the current round
        let currentQuestionIndex = 0; // Index of the current question
        let score = 0; // Player's current score
        let correctCount = 0; // Number of correct answers
        let timer; // Holds the setInterval ID for the timer
        let timeLeft = 0; // Remaining time for the current question, initialized dynamically
        let selectedCategory = null; // Stores the user's selected quiz category
        let selectedDifficulty = null; // Stores the user's selected difficulty

        // --- AUDIO SYNTHESIZERS (Tone.js) ---
        // Simple synth for correct answers
        const correctSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "triangle" },
            envelope: {
                attack: 0.005,
                decay: 0.1,
                sustain: 0.05,
                release: 0.1
            }
        }).toDestination();

        // Simple synth for incorrect answers
        const incorrectSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "sawtooth" },
            envelope: {
                attack: 0.01,
                decay: 0.2,
                sustain: 0.0,
                release: 0.2
            }
        }).toDestination();

        // --- INITIALIZATION ---
        // Initializes the game by populating categories and adding event listeners
        function init() {
            populateCategories();
            populateDifficulties(); // Populate difficulty options
            addEventListeners();
            showScreen('home'); // Ensure home screen is visible on load
            updateStartButtonState(); // Update button state initially
        }

        // Populates the category selection buttons on the home screen
        function populateCategories() {
            categorySelector.innerHTML = ''; // Clear existing buttons
            Object.keys(quizData).forEach(category => {
                const button = document.createElement('button');
                button.className = 'p-4 bg-slate-800 rounded-lg font-semibold hover:bg-purple-600 hover:text-white transition-all duration-200 border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-yellow-400';
                button.textContent = category;
                button.dataset.category = category; // Store category name in a data attribute
                button.addEventListener('click', () => selectCategory(category, button));
                categorySelector.appendChild(button);
            });
        }

        // Populates the difficulty selection buttons on the home screen
        function populateDifficulties() {
            difficultySelector.innerHTML = ''; // Clear existing buttons
            const difficulties = ['easy', 'medium', 'hard'];
            difficulties.forEach(difficulty => {
                const button = document.createElement('button');
                button.className = 'p-4 bg-slate-800 rounded-lg font-semibold hover:bg-purple-600 hover:text-white transition-all duration-200 border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-yellow-400 capitalize';
                button.textContent = difficulty;
                button.dataset.difficulty = difficulty;
                button.addEventListener('click', () => selectDifficulty(difficulty, button));
                difficultySelector.appendChild(button);
            });
        }
        
        // Handles category selection, updates UI and enables start button
        function selectCategory(category, button) {
            selectedCategory = category;
            // Reset styles for all category buttons
            document.querySelectorAll('#category-selector button').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white', 'border-yellow-400');
                btn.classList.add('bg-slate-800');
            });
            // Apply active style to the clicked button
            button.classList.add('bg-purple-600', 'text-white');
            button.classList.remove('bg-slate-800');
            updateStartButtonState();
        }

        // Handles difficulty selection, updates UI and enables start button
        function selectDifficulty(difficulty, button) {
            selectedDifficulty = difficulty;
            // Reset styles for all difficulty buttons
            document.querySelectorAll('#difficulty-selector button').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white', 'border-yellow-400');
                btn.classList.add('bg-slate-800');
            });
            // Apply active style to the clicked button
            button.classList.add('bg-purple-600', 'text-white');
            button.classList.remove('bg-slate-800');
            updateStartButtonState();
        }

        // Updates the state of the start quiz button based on category and difficulty selection
        function updateStartButtonState() {
            if (selectedCategory && selectedDifficulty) {
                startQuizBtn.disabled = false;
                startQuizBtn.textContent = 'Start Quiz!';
            } else {
                startQuizBtn.disabled = true;
                startQuizBtn.textContent = 'Select Category & Difficulty to Start';
            }
        }

        // Adds all necessary event listeners for game buttons and keyboard shortcuts
        function addEventListeners() {
            startQuizBtn.addEventListener('click', startQuiz);
            playAgainBtn.addEventListener('click', startQuiz);
            homeBtn.addEventListener('click', () => {
                showScreen('home');
                resetGame();
                // Deselect category and difficulty and disable start button when going back to home
                selectedCategory = null;
                selectedDifficulty = null;
                updateStartButtonState(); // Re-evaluate button state
                document.querySelectorAll('#category-selector button').forEach(btn => {
                    btn.classList.remove('bg-purple-600', 'text-white');
                    btn.classList.add('bg-slate-800');
                });
                document.querySelectorAll('#difficulty-selector button').forEach(btn => {
                    btn.classList.remove('bg-purple-600', 'text-white');
                    btn.classList.add('bg-slate-800');
                });
            });
            
            // Keyboard shortcuts for answering questions (1, 2, 3, 4)
            document.addEventListener('keydown', (e) => {
                // Only active if game screen is visible and options are displayed
                if (gameScreen.classList.contains('hidden') || optionsContainer.children.length === 0) return;
                if (['1', '2', '3', '4'].includes(e.key)) {
                    const optionButtons = optionsContainer.querySelectorAll('button');
                    const index = parseInt(e.key) - 1; // Convert key to 0-based index
                    if (optionButtons[index] && !optionButtons[index].disabled) { // Check if button exists and is not disabled
                        optionButtons[index].click(); // Simulate a click on the corresponding option button
                    }
                }
            });
        }
        
        // --- GAME FLOW ---
        // Starts the quiz after category and difficulty selection
        function startQuiz() {
            if (!selectedCategory || !selectedDifficulty) {
                console.error("Category or Difficulty not selected!");
                return;
            }
            // Ensure Tone.js context is running for sound effects
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
            playStartSound(); // Play start sound
            resetGame(); // Reset game state for a new round
            // Set time per question based on selected difficulty
            timeLeft = TIME_PER_QUESTION_CONFIG[selectedDifficulty]; 

            // Shuffle questions from the selected category and difficulty and pick the required number
            currentQuestions = shuffleArray(quizData[selectedCategory][selectedDifficulty]).slice(0, QUESTIONS_PER_ROUND);
            showScreen('game'); // Show the game screen
            loadNextQuestion(); // Load the first question
        }
        
        // Resets all game-related state variables
        function resetGame() {
            currentQuestionIndex = 0;
            score = 0;
            correctCount = 0;
            scoreDisplay.textContent = '0';
            questionCounter.textContent = `1 / ${QUESTIONS_PER_ROUND}`;
            clearInterval(timer); // Clear any running timer
            confettiContainer.innerHTML = ''; // Clear confetti from previous game
        }

        // Loads the next question or ends the quiz if all questions are answered
        function loadNextQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                endQuiz(); // All questions answered, end the quiz
                return;
            }

            resetQuestionUI(); // Reset UI elements (shake, score animation)
            
            const question = currentQuestions[currentQuestionIndex];
            questionText.textContent = "Loading question..."; // Show loading state
            optionsContainer.innerHTML = ''; // Clear previous options to prevent interaction during load

            // Small delay to simulate loading and show loading text
            setTimeout(() => {
                questionText.textContent = question.question;
                questionCounter.textContent = `${currentQuestionIndex + 1} / ${QUESTIONS_PER_ROUND}`;
                
                // Create and append option buttons for the current question
                const shuffledOptions = shuffleArray(question.options); // Shuffle options to randomize order
                shuffledOptions.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'w-full bg-slate-700 p-4 rounded-lg text-left font-semibold hover:bg-purple-600 transition-all duration-200 disabled:opacity-50 disabled:hover:bg-slate-700';
                    button.innerHTML = `<span class="bg-slate-600 text-yellow-300 font-bold rounded-md px-2 py-1 mr-4">${index + 1}</span>${option}`;
                    button.addEventListener('click', () => selectAnswer(option, question.answer, button));
                    optionsContainer.appendChild(button);
                });

                startTimer(); // Start the timer for the new question
            }, 300); // Short delay
        }
        
        // Handles the user's answer selection
        function selectAnswer(selected, correct, button) {
            clearInterval(timer); // Stop the timer immediately
            const isCorrect = selected === correct;

            // Disable all option buttons to prevent multiple answers
            optionsContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);

            if (isCorrect) {
                // Correct answer: update score, apply styling, play sound
                score += 100 + (timeLeft * 10); // Base points + time bonus
                correctCount++;
                scoreDisplay.textContent = score;
                scoreDisplay.classList.add('count-up'); // Trigger score animation
                button.classList.remove('bg-slate-700');
                button.classList.add('bg-green-500', 'ring-4', 'ring-green-300');
                playCorrectSound();
            } else {
                // Incorrect answer: apply shake animation, highlight incorrect, then show correct, play sound
                questionCard.classList.add('shake'); // Trigger shake animation
                button.classList.remove('bg-slate-700');
                button.classList.add('bg-red-500', 'ring-4', 'ring-red-300');
                playIncorrectSound();

                // Highlight the correct answer among the options
                optionsContainer.querySelectorAll('button').forEach(btn => {
                    // Extract text content by removing the number prefix
                    const optionText = btn.textContent.replace(/^\s*\d+\s*/, ''); 
                    if (optionText === correct) {
                        btn.classList.remove('bg-slate-700');
                        btn.classList.add('bg-green-500');
                    }
                });
            }
            
            // Move to the next question after a short delay to allow visual feedback
            setTimeout(() => {
                currentQuestionIndex++;
                loadNextQuestion();
            }, 1500);
        }
        
        // Ends the quiz and displays the results screen
        function endQuiz() {
            showScreen('result');
            animateScore(); // Animate the final score count-up
            correctAnswers.textContent = correctCount;
            incorrectAnswers.textContent = currentQuestions.length - correctCount;

            // Launch confetti for good scores (e.g., more than half correct, considering time bonus too)
            if (correctCount >= QUESTIONS_PER_ROUND / 2) { // Changed condition to be based on correct answers count
                launchConfetti();
            }
            playEndSound(); // Play end sound
        }
        
        // --- TIMER LOGIC ---
        // Starts the countdown timer for the current question
        function startTimer() {
            // Reset timeLeft to the appropriate value for the current difficulty
            timeLeft = TIME_PER_QUESTION_CONFIG[selectedDifficulty]; 
            timerBar.style.transition = 'none'; // Reset transition to instantly set width to 100%
            timerBar.style.width = '100%';
            
            // Force a reflow to ensure the width change is applied before starting the transition
            void timerBar.offsetWidth; 
            
            timerBar.style.transition = `width ${timeLeft}s linear`; // Apply full transition based on current timeLeft
            timerBar.style.width = '0%'; // Start shrinking the bar

            clearInterval(timer); // Clear any previously running timer
            timer = setInterval(() => {
                timeLeft--;
                if (timeLeft < 0) {
                    clearInterval(timer); // Stop timer
                    timeUp(); // Handle time running out
                }
            }, 1000); // Update every second
        }

        // Handles the scenario when the time for a question runs out
        function timeUp() {
            // Treat as an incorrect answer
            questionCard.classList.add('shake'); // Apply shake animation
            optionsContainer.querySelectorAll('button').forEach(btn => {
                btn.disabled = true; // Disable all options
                // Highlight the correct answer
                const optionText = btn.textContent.replace(/^\s*\d+\s*/, ''); 
                if (optionText === currentQuestions[currentQuestionIndex].answer) {
                    btn.classList.remove('bg-slate-700');
                    btn.classList.add('bg-green-500');
                }
            });
            playIncorrectSound(); // Play incorrect sound for time-up

            // Move to the next question after a delay
            setTimeout(() => {
                currentQuestionIndex++;
                loadNextQuestion();
            }, 1500);
        }

        // --- AUDIO FUNCTIONS ---
        function playCorrectSound() {
            correctSynth.triggerAttackRelease("C5", "8n"); // A simple high pitched sound
        }

        function playIncorrectSound() {
            incorrectSynth.triggerAttackRelease("C3", "8n"); // A simple low pitched sound
        }

        function playStartSound() {
            correctSynth.triggerAttackRelease(["C4", "E4", "G4"], "4n"); // A simple chord for start
        }

        function playEndSound() {
            // More elaborate chord for end
            correctSynth.triggerAttackRelease(["C5", "E5", "G5"], "2n", Tone.now());
            correctSynth.triggerAttackRelease(["C6", "E6", "G6"], "2n", Tone.now() + 0.2);
        }


        // --- UI & ANIMATION HELPERS ---
        // Resets UI elements for the next question
        function resetQuestionUI() {
            questionCard.classList.remove('shake'); // Remove shake animation class
            scoreDisplay.classList.remove('count-up'); // Remove score animation class
            timerBar.style.transition = 'width 0.1s linear'; // Reset timer bar transition for next question start
            timerBar.style.width = '100%'; // Ensure timer bar is full at the start of a new question
        }
        
        // Manages which game screen is visible
        function showScreen(screenName) {
            homeScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            
            if (screenName === 'home') homeScreen.classList.remove('hidden');
            else if (screenName === 'game') gameScreen.classList.remove('hidden');
            else if (screenName === 'result') resultScreen.classList.remove('hidden');
        }

        // Animates the final score counting up on the result screen
        function animateScore() {
            let displayedScore = 0;
            const scoreInterval = setInterval(() => {
                // Calculate increment to smoothly reach the final score
                const increment = Math.ceil((score - displayedScore) / 10);
                displayedScore += increment;
                if (displayedScore >= score) {
                    displayedScore = score; // Ensure it doesn't overshoot
                    clearInterval(scoreInterval); // Stop animation when done
                }
                finalScore.textContent = displayedScore;
            }, 50); // Update every 50ms
        }

        // Creates and launches confetti particles on the result screen
        function launchConfetti() {
            confettiContainer.innerHTML = ''; // Clear any old confetti
            const colors = ['#fde047', '#a855f7', '#4ade80', '#fb7185', '#0ea5e9', '#ec4899']; // Define more confetti colors
            for (let i = 0; i < 150; i++) { // Generate more confetti pieces
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}%`; // Random horizontal position
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]; // Random color
                confetti.style.animationDelay = `${Math.random() * 3}s`; // Random start delay for staggered fall
                confetti.style.animationDuration = `${2 + Math.random() * 2}s`; // Random animation duration
                confetti.style.transform = `rotate(${Math.random() * 360}deg) scale(${0.5 + Math.random()})`; // Random initial rotation and size
                confettiContainer.appendChild(confetti);
            }
        }

        // --- UTILITY ---
        // Fisher-Yates shuffle algorithm to randomize array order
        function shuffleArray(array) {
            // Create a shallow copy to avoid modifying the original array if it's referenced elsewhere
            const newArray = [...array]; 
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]]; // Swap elements
            }
            return newArray;
        }

        // --- START THE APP ---
        init(); // Call initialization function when the script loads
    </script>
</body>
</html>
